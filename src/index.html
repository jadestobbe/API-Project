<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>API Project</title>
  <link rel="import" href="customelem.html" />
  <script src="/page/page.js"></script>
</head>
<body>
  <form name="searchBar">
    <input type="text" name="summonerName" placeholder="Summoner Name" >
    <input type="submit" value="Submit">
  </form>
  <custom-elem></custom-elem>
</body>

<script>
      var key = "0ffcffa0-22a4-438b-a3b6-c4dd6b66d69f";
      var custom = document.getElementsByTagName('CUSTOM-ELEM')[0];
      page.base('');
      page('/', startPage);
      page('/:summonerName', findSummoner);
      page('/:summonerName/recientGames', showGames);
      page('*', notFound);
      page({hashbang:true});
      //page();
      function startPage(ctx, next){
        custom._view("view1");
        next();
      }

      function notFound(){
        //do nothing
      }
      function findSummoner(ctx, next){
        var summonerName = ctx.params.summonerName;
        custom.summonerNameLowercase = summonerName;
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "https://na.api.pvp.net/api/lol/na/v1.4/summoner/by-name/"+summonerName+"?api_key="+key, true);
        xhr.onload = function(){
           var json = JSON.parse(xhr.responseText);
           if(json["status"]){
             custom._summonerFound = false;
           }
           else{
             var summonerInfo = json[summonerName];
             custom.summonerId = summonerInfo["id"];
             custom.summonerName = summonerInfo["name"];
             custom._summonerFound = true;
           }
           var xhr2 = new XMLHttpRequest();
           //xhr2.open("GET", "https://na.api.pvp.net/api/lol/na/v1.3/stats/by-summoner/"+custom.summonerId+"/summary?season=SEASON2016&api_key="+ key,true);
           xhr2.open("GET", "https://na.api.pvp.net/api/lol/na/v2.5/league/by-summoner/"+custom.summonerId+"?api_key="+ key,true);
           xhr2.onload = function(){
             var json2 = JSON.parse(xhr2.responseText);
             var jsonLength = json2[custom.summonerId].length;
             var rankedData = json2[custom.summonerId][0];
             custom.rank = rankedData["tier"];
             var specificSummonerData;
             for(var i = 0; i < rankedData["entries"].length; i++){
               if(rankedData["entries"][i]["playerOrTeamName"] === custom.summonerName){
                 specificSummonerData = rankedData["entries"][i];
                 break;
               }
             }
             custom.rank = custom.rank + " " + specificSummonerData["division"];
             custom.wins = specificSummonerData["wins"];
             custom.losses = specificSummonerData["losses"];
             custom.totalGames = custom.wins + custom.losses;
           }
           xhr2.send();
        };
        xhr.send();
        custom._view("view2");
        next();
      }
      function showGames(){
        custom.recientGames = [];
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "https://na.api.pvp.net/api/lol/na/v1.3/game/by-summoner/"+custom.summonerId+"/recent?api_key="+key, true);
        xhr.onload = function(){
          var json = JSON.parse(xhr.responseText);
          console.log(json);
          custom.recientGames = json["games"];
        }
        xhr.send();
        custom._view("view3");
      }

</script>
</html>
